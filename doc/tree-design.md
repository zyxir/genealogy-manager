# 家谱树的实现细节

在家谱树的创建过程中，整个树的数据结构并不构成 m 叉树。一方面，用户在编辑过程中，可能尚未完成所有节点的连线，导致存在孤立节点；另一方面，某些代可能有人员迁入村庄，导致族谱中产生多棵树；还有一些直接血缘关系未知、只知道是祖先的人员。因此，家谱树的存储，除了存储父子关系外，还需要存储：

- `gmlib.Tree._node_dict`: 数字 ID 与节点的映射。
- `gmlib.Tree._node_layers`: 节点层级，每一层级表示一世，索引顺序表示在绘图中的左右关系。

为了方便反向查找索引，还存储了：

- `gmlib.Tree._node_indices`: 数字 ID 与索引 (y, x) 的映射。

## 原子操作

家谱树的编辑可由下列原子操作构成（原子操作由数据结构 `gmlib.models.TreeEdit` 表示，用于实现「撤消」功能）：

1. 添加节点：在指定层添加节点
2. 添加关系：添加两给定节点的关系
3. 移动节点：移动节点，以及以它为根节点的整棵子树
4. 删除节点：删除某一节点
5. 删除关系：删除两给定节点的关系

显然，1 与 4、2 与 5 是可逆的，3 与自己是可逆的。
